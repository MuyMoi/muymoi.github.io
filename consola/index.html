<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Consola</title>
<style>

/*  Para que el body tenga la altura maxima */

html, body {
	height: 100%;
	margin: 0;
}

/*  Configuracion flexbox  */
body {
	display: flex;
	flex-direction: column;
}

#contenedor_resultados {
	flex: 1;
}

/* -------------------------*/


#contenedor_resultados {
	margin: 0 10px; /*top-bottom  left-right*/
	overflow: scroll;
}

div.resultado {
	font-family: monospace;
	padding: 10px;
	white-space: pre;
	background-color: lightgray;
	margin-bottom: 10px;
	overflow-x: scroll;
}

.codigo {
	font-style: italic;
	color: darkgreen;
	border-bottom: 1px solid darkgreen;
}

.error {
	margin-left: 20px;
	color: brown;
}

.result_eval {
	margin-left: 20px;
	color: blue;
}

.normal {
	margin-left: 20px;
	color: black;
}

.tabla_result {
	margin-left: 20px;
	color: blue;
}

caption {
  font-weight: bold;
}

/* --------------------  */

/* El siguiente tiene configuracion grid */
#codigo {
	margin: auto;
	background-color: white;
	min-height: 90px;
	width: 95%;
	border-top: 6px solid gray;
	padding-bottom: 20px;
	display: grid;
	grid-template-columns: auto 4.5em;
}

#codigo textarea {
	resize: vertical;
	grid-row: 1 / span 4;
	/*
	lo anterior es lo mismo que:
	
	grid-row-start: 1;
  	grid-row-end: 4;
  	*/
}

#codigo input { display: none }

</style>

</head>

<body>

<div id="contenedor_resultados"></div>
<div id="codigo">
	<textarea id="text"
		placeholder="Escribe aqui tu codigo JavaScript"
		autocapitalize="off"></textarea>
	<button id="exec">Ejecutar</button>
	<button id="clear">Limpiar</button>
	<button id="download">Descargar</button>
	<button id="import">Importar</button>
	<input type="file" id="import_input">
</div>

<script>

alert("Esta es una consola JavaScript, imitacion de "
	+ "las consolas que proveen los navegadores con F12.\n"
	+ "Usa el metodo escribir(texto).\n"
	+ "Usa el metodo mostrarPropsObj(obj) para mostrar TODAS "
	+ "las propiedades de un objeto.\n"
	+ "Toca un comando del historial para editarlo.")

let botones = document.querySelectorAll('button'),
    texto = document.getElementById('text'),
    exec = botones[0],
    clear = botones[1],
    res = document.getElementById('contenedor_resultados'),
    historialbueno = "",
    desc = botones[2],
    imp = botones[3],
    inputfile = document.getElementById('import_input')

function escribir(variable, tipo="normal", elem) {
	//El argumento indica la clase de formato:
	//normal: letras negras sin italica ni negrita
	//result_eval: lo que devuelve eval
	//error: para mensajes de error
	//codigo: para el codigo que ejecuto el usuario
	if (typeof variable == "object" && variable != null) {
		mostrarPropsObj(variable, false)
		return
	}

	if (typeof elem == "undefined")
		elem = agregar_parrafo_result(tipo)
	elem.className = tipo

	if (typeof variable == "string" && tipo != "error") {
		elem.innerHTML += `"${variable}"`
	} else {
		elem.innerHTML += variable
	}

	return "Fin escribir"
}

function mostrarPropsObj(obj, mostrarprototipo=true) {
  let t = agregar_tabla_result(),
      capt = t.createCaption()

  let props = Object.getOwnPropertyNames(obj)
  
  if (mostrarprototipo) {
    let proto = obj.__proto__
    
    while(proto != null) {
      let b = Object.getOwnPropertyNames(proto)
      props.push(...b)
      proto = proto.__proto__
    }
  }
  
  capt.innerHTML = "Numero de propiedades:" + props.length
  
  for (let p of props) {
		let fila = t.insertRow(),
			cel1 = fila.insertCell(),
			cel2 = fila.insertCell()

		cel1.innerHTML = p + ":"

		try {
			let valor = obj[p]

			if (typeof valor == "string") {
				cel2.innerHTML += `"${valor}"`
			} else if (typeof valor == "function") {
				cel2.innerHTML += "function" 
			} else {
				cel2.innerHTML += `${valor}`
			}
		} catch(e) {
			cel2.className = "error"
			cel2.innerHTML = "<b>" + e.name + ":</b> " + e.message
		}
	}
}

exec.onclick = ()=> {
	texto.focus()

	if (texto.value == "")
		return

	agregar_div_result()

	let p = agregar_parrafo_result("codigo")
	let retorno

	p.innerText = texto.value

	try {
		retorno = eval?.(texto.value)
		escribir(retorno, "result_eval")
		historialbueno += texto.value + "\n"
	} catch (e) {
		escribir("<b>" + e.name + ":</b> " + e.message, "error")
	}

	res.scrollBy({
		left: 0,
		top: 100,
		behavior: "smooth"
	})
}

clear.onclick = (e)=> {
	res.innerHTML = ""
}

res.onclick = (e)=> {
	let elem = e.target
	
	if (elem.id == "contenedor_resultados") return
	
	while (elem.className != "resultado"){
	  elem = elem.parentElement
	}
	
	texto.value = elem.firstChild.innerText
}

desc.onclick = function () {
  if (historialbueno == "") return

	let f = new Blob([historialbueno], {type:"text/plain"}),
		url = URL.createObjectURL(f),
		a = document.createElement("a")

	a.href = url
	a.download = "historial.txt"
	a.click()
	URL.revokeObjectURL(url)
}

imp.onclick = function() {
	inputfile.showPicker()
}

inputfile.onchange = function(e) {
	inputfile.files[0].text()
	  .then((t)=>texto.value = t)
}

function agregar_div_result() {
	let d = document.createElement("div")
	d.className = "resultado"
	res.appendChild(d)
}

function agregar_parrafo_result(tipo) {
	//El argumento tipo admite lo mismo
	//que en la funcion escribir
	let p = document.createElement("p")
	p.className = tipo
	res.lastChild.appendChild(p)

	return p
}

function agregar_tabla_result() {
	let t = document.createElement("table")
	t.className = "tabla_result"
	res.lastChild.appendChild(t)

	return t
}

</script>

</body>

</html>
